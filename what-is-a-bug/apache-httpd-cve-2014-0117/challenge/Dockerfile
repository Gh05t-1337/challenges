FROM ubuntu:20.04
ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y \
      build-essential wget ca-certificates tar gzip curl python3 \
      libpcre3-dev libexpat1-dev zlib1g-dev libapr1-dev libaprutil1-dev \
 && rm -rf /var/lib/apt/lists/*

WORKDIR /tmp
ARG HTTPD_VER=2.4.9
RUN wget -q https://archive.apache.org/dist/httpd/httpd-${HTTPD_VER}.tar.gz \
 && tar xzf httpd-${HTTPD_VER}.tar.gz \
 && cd httpd-${HTTPD_VER} \
 && ./configure \
      --prefix=/opt/httpd \
      --with-mpm=worker \
      --enable-so \
      --enable-mods-shared=most \
      --enable-proxy --enable-proxy-http \
      --enable-log_config \
 && make -j"$(nproc)" && make install

RUN mkdir -p /opt/backend /var/www/html /challenge/bin
COPY backend.py /opt/backend/backend.py
COPY httpd.conf /opt/httpd/conf/httpd.conf
COPY .init /challenge/.init
COPY bin/win /challenge/bin/win

RUN chmod 0555 /challenge/.init /challenge/bin/win /opt/backend/backend.py \
 && echo OK > /var/www/html/health
