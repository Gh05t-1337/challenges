FROM ubuntu:24.04
RUN apt-get update && apt-get install -y cmake build-essential python3-pwntools git
ADD --chown=0:0 --chmod=6755 http://github.com/pwncollege/exec-suid/releases/latest/download/exec-suid /usr/bin/exec-suid
COPY challenge.c crash_to_flag.c /challenge/
RUN <<END
    set -e
    mkdir -p /challenge/bin
    cd /challenge

    git clone https://github.com/pnggroup/libpng
    git config --global user.email "you@example.com"
    git config --global user.name "Your Name"
    git -C libpng checkout 2b37d46564b48efa0298f57134c6a555c223ee44
    git -C libpng revert 2b37d46564b48efa0298f57134c6a555c223ee44
    git -C libpng diff 347538e 2b37d465 > /challenge/patch.diff

    mkdir /challenge/libpng/build
    cd /challenge/libpng/build
    cmake -DCMAKE_INSTALL_PREFIX=/challenge -DCMAKE_BUILD_TYPE=Release ../
    make
    make install
    git -C /challenge/libpng clean -fxxd

    gcc -I/challenge/include /challenge/*.c /challenge/lib/libpng.a -lz -lm -o /challenge/bin/challenge
    chmod 6755 /challenge/bin/challenge
END
