FROM ubuntu:24.04
RUN apt-get update && apt-get install -y cmake build-essential python3-pwntools git flex bison autoconf automake libtool libncurses5-dev vim
ADD --chown=0:0 --chmod=6755 http://github.com/pwncollege/exec-suid/releases/latest/download/exec-suid /usr/bin/exec-suid

COPY send_mutt_message.c crash_to_flag.c /challenge/
RUN echo '#!/bin/sh\ncat > /tmp/mutt-mail.out\nexit 0' > /usr/sbin/sendemail \
    && chmod +x /usr/sbin/sendemail
RUN <<'END'
    set -e
    mkdir -p /challenge/bin
    cd /challenge

    git clone https://gitlab.com/muttmua/mutt.git 
    git config --global user.email "you@example.com"
    git config --global user.name "Your Name"
    git -C mutt checkout 7eb9c18f27d14f3fbdf4f844c1b683a659bc48aa
    git -C mutt diff 7eb9c18f27d14f3fbdf4f844c1b683a659bc48aa 452ee330e094bfc7c9a68555e5152b1826534555 > /challenge/patch.diff

    cd /challenge/mutt
    ./prepare
    ./configure --prefix=/challenge/
    make install

    echo 'set sendmail="/usr/sbin/sendemail"' > /challenge/etc/Muttrc

    gcc -I/challenge/include -o /challenge/bin/send_mutt_message /challenge/send_mutt_message.c -L/challenge/lib
    gcc -fPIC -shared -o /challenge/crash_to_flag.so /challenge/crash_to_flag.c
    chmod 6755 /challenge/bin/send_mutt_message
END

ENV PATH="/challenge/bin:$PATH"
