# Dockerfile: build unpatched bash-4.3 in a historically-compatible environment
FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive

RUN mkdir -p /challenge/bin
COPY run_bashfile.c crash_to_flag.c /challenge/

WORKDIR /opt

# Install build deps (including bison so parse.y is generated)
RUN apt-get update && apt-get install -y --no-install-recommends \
    cmake python3-pwntools git build-essential wget bison flex gettext gawk perl file ca-certificates \
    && rm -rf /var/lib/apt/lists/*
# Fetch bash 4.3 source
RUN wget -q https://ftp.gnu.org/gnu/bash/bash-4.3.tar.gz && \
    tar -xzf /opt/bash-4.3.tar.gz -C /opt && rm /opt/bash-4.3.tar.gz
RUN wget https://ftp.gnu.org/gnu/bash/bash-4.3-patches/bash43-027 -O /challenge/patch.diff
ADD --chown=0:0 --chmod=6755 http://github.com/pwncollege/exec-suid/releases/latest/download/exec-suid /usr/bin/exec-suid
WORKDIR /opt/bash-4.3

# Configure and build (debug symbols, no optimization), install to /opt/bash43
RUN CFLAGS="-g -O0 -D_GNU_SOURCE" ./configure --prefix=/opt/bash43 && \
    make -j"$(nproc)" && \
    make install

# Build helper binary
RUN gcc -fPIC -shared -o /challenge/crash_to_flag.so /challenge/crash_to_flag.c
RUN gcc -I/challenge/include -o /challenge/bin/run_bashfile /challenge/*.c -L/challenge/lib
RUN chmod 0755 /challenge/bin/run_bashfile
RUN chmod 755 /opt/bash43/bin/bash
